# Template file for 'wine'
pkgname=wine
version=2.10
revision=1
build_style=gnu-configure
configure_args="--prefix=/usr --with-x"
short_desc="Run Microsoft Windows applications"
maintainer="Andrea Brancaleoni <abc@pompel.me>"
license="LGPL-2.1"
homepage="http://www.winehq.org/"
distfiles="https://dl.winehq.org/wine/source/${version%.*}.x/wine-${version}.tar.xz"
checksum=488df7ffd2e81da455bf428fc9eb784bb4273a890334500895665711bd52f179

CC="gcc"
CFLAGS="-O2 -pipe"
configure_script=../configure

lib32mode=full
only_for_archs="x86_64"

hostmakedepends="pkg-config flex prelink"
makedepends="gettext-devel lcms2-devel zlib-devel ncurses-devel
 glu-devel libSM-devel libXext-devel libX11-devel libXpm-devel
 libXinerama-devel libXcomposite-devel libXmu-devel libXxf86vm-devel
 libXcursor-devel libXrandr-devel libXdamage-devel libXi-devel
 libldap-devel alsa-lib-devel libgphoto2-devel libxml2-devel gst-plugins-base1-devel
 libxslt-devel glib-devel freetype-devel pulseaudio-devel
 mpg123-devel libgsm-devel libopenal-devel giflib-devel libpng-devel
 v4l-utils-devel fontconfig-devel gnutls-devel dbus-devel sane-devel
 libpcap-devel cups-devel dbus-devel ocl-icd-devel
 gettext-devel-32bit lcms2-devel-32bit zlib-devel-32bit ncurses-devel-32bit
 glu-devel-32bit libSM-devel-32bit libXext-devel-32bit libX11-devel-32bit
 libXinerama-devel-32bit libXcomposite-devel-32bit libXmu-devel-32bit
 libXcursor-devel-32bit libXrandr-devel-32bit libXdamage-devel-32bit libXi-devel-32bit
 libldap-devel alsa-lib-devel-32bit libgphoto2-devel-32bit libxml2-devel-32bit
 libxslt-devel-32bit freetype-devel-32bit pulseaudio-devel-32bit
 mpg123-devel-32bit libgsm-devel-32bit libopenal-devel-32bit giflib-devel-32bit
 fontconfig-devel-32bit gnutls-devel-32bit dbus-devel-32bit sane-devel-32bit libldap-devel
 libpcap-devel-32bit cups-devel-32bit ocl-icd-devel-32bit
 libgcc-devel-32bit cross-i686-pc-linux-gnu-libc cross-i686-pc-linux-gnu
 glibc-devel-32bit libstdc++-devel-32bit gcc-multilib libconfig-devel-32bit
 libXxf86vm-devel-32bit libpng-devel-32bit libXpm-devel-32bit
 gst-plugins-base1-devel-32bit"

# libldap-devel-32bit removed because #6680

depends="libXi libXinerama libXcomposite libXcursor libOSMesa
 desktop-file-utils hicolor-icon-theme liberation-fonts-ttf gnutls libXi-32bit
 libXinerama-32bit libXcomposite-32bit libXcursor-32bit libOSMesa-32bit gnutls-32bit"

binfmts="/usr/bin/wine --magic MZ"

build_options="staging"
desc_option_staging="Enable wine-staging patchset"
build_options_default="staging"

nopie=yes

if [ ${build_option_staging} ]; then
	hostmakedepends+=" automake"
fi

if [ ${build_option_staging} ]; then
	makedepends+=" libva-devel gtk+3-devel libva-devel-32bit  gtk+3-devel-32bit"
	distfiles+=" https://github.com/wine-compholio/wine-staging/archive/v${version}.tar.gz"
	checksum+=" b361ec92b2e40de983b987f6564dbb75dcb121c6e2f0123fe1ae234fd81a591b"
fi

post_extract() {
	if [ ${build_option_staging} ]; then
		cd ${XBPS_BUILDDIR}/${pkgname}-staging-${version}/patches/
		DESTDIR="$wrksrc" ./patchinstall.sh --all
	fi
}

pre_configure() {
	mkdir wine64
	mkdir wine32
	sed -i s/lib64/lib/g configure
}

do_configure() {
	# Configure wine 64bit build
	cd wine64
	${configure_script} ${configure_args} --enable-win64 --libdir="/usr/lib"
}


do_build() {
	: ${make_cmd:=make}

	# Build wine 64bit
	cd wine64
	${make_cmd} ${makejobs} ${make_build_args} LIBDIR="/usr/lib" DLLDIR="/usr/lib/wine" ${make_build_target}

	# Configure wine 32bit using built 64bit files
	cd ../wine32
	PKG_CONFIG_LIBDIR=/usr/lib32/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig ${configure_script} ${configure_args} --with-wine64=../wine64 --libdir="/usr/lib32"

	# Build wine 32bit with wine64 files
	${make_cmd} ${makejobs} ${make_build_args} DLLDIR="/usr/lib32" LIBDIR="/usr/lib32/wine" ${make_build_target}
}

do_install() {
	: ${make_cmd:=make}
	: ${make_install_target:=install}

	# Install wine32 first
	cd wine32
	${make_cmd} DESTDIR=${DESTDIR} ${make_install_args} ${make_install_target}

	# Install wine64 second
	cd ../wine64
	${make_cmd} DESTDIR=${DESTDIR} ${make_install_args} ${make_install_target}
}

post_install() {
	# Font aliasing settings for Win32 applications
	install -d ${DESTDIR}/etc/fonts/conf.{avail,d}
	install -m644 ${FILESDIR}/30-win32-aliases.conf ${DESTDIR}/etc/fonts/conf.avail
	ln -s ../conf.avail/30-win32-aliases.conf ${DESTDIR}/etc/fonts/conf.d/30-win32-aliases.conf
}

libwine_package() {
	#lib32mode=full
	short_desc+=" - Runtime library"
	replaces="libwine-unstable>=0"
	pkg_install() {
		vmove "usr/lib/*.so.*"
		vmove "usr/lib32/*.so.*"
		vmove usr/lib/wine
		vmove usr/lib32/wine
	}
}

wine-devel_package() {
	depends="libwine-${version}_${revision}"
	short_desc+=" - development files"
	replaces="wine-unstable-devel>=0"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.so"
		vmove "usr/lib32/*.so"
	}
}
